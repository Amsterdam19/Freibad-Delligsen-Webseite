{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import Plugin from '@swup/plugin';\nimport { Location, getCurrentUrl } from 'swup';\nimport type { DelegateEvent, DelegateEventUnsubscribe } from 'swup';\n\ndeclare module 'swup' {\n\texport interface HookDefinitions {\n\t\t'form:submit': { el: HTMLFormElement; event: DelegatedSubmitEvent };\n\t\t'form:submit:newtab': { el: HTMLFormElement; event: DelegatedSubmitEvent };\n\t}\n}\n\ntype DelegatedSubmitEvent = DelegateEvent<SubmitEvent, HTMLFormElement>;\n\ntype Options = {\n\tformSelector: string;\n};\n\ntype FormInfo = {\n\turl: string;\n\thash: string;\n\tmethod: 'GET' | 'POST';\n\tdata: FormData;\n\tbody: URLSearchParams | FormData;\n\tencoding: string;\n};\n\nexport default class SwupFormsPlugin extends Plugin {\n\tname = 'SwupFormsPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: Options = {\n\t\tformSelector: 'form[data-swup-form]'\n\t};\n\toptions: Options;\n\n\t// Track pressed keys to detect form submissions to a new tab\n\tspecialKeys: { [key: string]: boolean } = {\n\t\tMeta: false,\n\t\tControl: false,\n\t\tShift: false\n\t};\n\n\tformSubmitDelegate?: DelegateEventUnsubscribe;\n\n\tconstructor(options: Partial<Options> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\tthis.swup.hooks.create('form:submit');\n\t\tthis.swup.hooks.create('form:submit:newtab');\n\n\t\t// Register the submit handler. Using `capture:true` to be\n\t\t// able to set the form's target attribute on the fly.\n\t\tthis.formSubmitDelegate = this.swup.delegateEvent(\n\t\t\tthis.options.formSelector,\n\t\t\t'submit',\n\t\t\tthis.beforeFormSubmit.bind(this),\n\t\t\t{\n\t\t\t\tcapture: true\n\t\t\t}\n\t\t);\n\n\t\tdocument.addEventListener('keydown', this.onKeyDown);\n\t\tdocument.addEventListener('keyup', this.onKeyUp);\n\t}\n\n\tunmount() {\n\t\tthis.formSubmitDelegate?.destroy();\n\n\t\tdocument.removeEventListener('keydown', this.onKeyDown);\n\t\tdocument.removeEventListener('keyup', this.onKeyUp);\n\t}\n\n\t/**\n\t * Handles form 'submit' events during the capture phase\n\t */\n\tbeforeFormSubmit(event: DelegatedSubmitEvent): void {\n\t\tconst swup = this.swup;\n\t\tconst form = event.delegateTarget;\n\t\tconst action = form.getAttribute('action') || getCurrentUrl();\n\t\tconst opensInNewTabFromKeyPress = this.isSpecialKeyPressed();\n\t\tconst opensInNewTabFromTargetAttr = form.getAttribute('target') === '_blank';\n\t\tconst opensInNewTab = opensInNewTabFromKeyPress || opensInNewTabFromTargetAttr;\n\n\t\t/**\n\t\t * Allow ignoring this form submission via callback\n\t\t * No use in checking if it will open in a new tab anyway\n\t\t */\n\t\tif (!opensInNewTab && swup.shouldIgnoreVisit(action, { el: form, event })) {\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Open the form in a new tab because of its target attribute\n\t\t */\n\t\tif (opensInNewTabFromTargetAttr) {\n\t\t\tswup.hooks.callSync('form:submit:newtab', { el: form, event });\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Open the form in a new tab if either Command (Mac), Control (Windows) or Shift is pressed.\n\t\t * Normalizes behavior across browsers.\n\t\t */\n\t\tif (opensInNewTabFromKeyPress) {\n\t\t\tswup.hooks.callSync('form:submit:newtab', { el: form, event });\n\n\t\t\tform.dataset.swupOriginalFormTarget = form.getAttribute('target') || '';\n\t\t\tform.setAttribute('target', '_blank');\n\t\t\tform.addEventListener(\n\t\t\t\t'submit',\n\t\t\t\t() => requestAnimationFrame(() => this.restorePreviousFormTarget(form)),\n\t\t\t\t{ once: true }\n\t\t\t);\n\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Trigger the form:submit hook.\n\t\t */\n\t\tswup.hooks.callSync('form:submit', { el: form, event }, () => {\n\t\t\tthis.submitForm(event);\n\t\t});\n\t}\n\n\t/**\n\t * Restores the previous form target if available\n\t */\n\trestorePreviousFormTarget(form: HTMLFormElement): void {\n\t\tif (form.dataset.swupOriginalFormTarget) {\n\t\t\tform.setAttribute('target', form.dataset.swupOriginalFormTarget);\n\t\t} else {\n\t\t\tform.removeAttribute('target');\n\t\t}\n\t}\n\n\t/**\n\t * Submits a form through swup\n\t */\n\tsubmitForm(event: DelegatedSubmitEvent): void {\n\t\tconst el = event.delegateTarget;\n\t\tconst { url, hash, method, data, body } = this.getFormInfo(el);\n\t\tlet action = url;\n\t\tlet params: { method: 'GET' | 'POST'; body?: FormData | URLSearchParams } = { method };\n\n\t\tswitch (method) {\n\t\t\tcase 'POST':\n\t\t\t\tparams = { method, body };\n\t\t\t\tbreak;\n\t\t\tcase 'GET':\n\t\t\t\taction = this.appendQueryParams(action, data);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tconsole.warn(`Unsupported form method: ${method}`);\n\t\t\t\treturn;\n\t\t}\n\n\t\tevent.preventDefault();\n\t\tthis.swup.cache.delete(action);\n\t\tthis.swup.navigate(action + hash, params, { el, event });\n\t}\n\n\t/**\n\t * Get information about where and how a form will submit\n\t */\n\tgetFormInfo(form: HTMLFormElement): FormInfo {\n\t\tconst action = form.getAttribute('action') || getCurrentUrl();\n\t\tconst { url, hash } = Location.fromUrl(action);\n\t\tconst method = (form.getAttribute('method') || 'get').toUpperCase() as 'GET' | 'POST';\n\t\tconst encoding = (\n\t\t\tform.getAttribute('enctype') || 'application/x-www-form-urlencoded'\n\t\t).toLowerCase();\n\t\tconst multipart = encoding === 'multipart/form-data';\n\t\tconst data = new FormData(form);\n\t\tlet body: FormData | URLSearchParams = data;\n\t\tif (!multipart) {\n\t\t\tbody = new URLSearchParams(data as unknown as Record<string, string>);\n\t\t}\n\t\treturn { url, hash, method, data, body, encoding };\n\t}\n\n\t/**\n\t * Appends query parameters to a URL\n\t */\n\tappendQueryParams(url: string, data: FormData): string {\n\t\tconst path = url.split('?')[0];\n\t\tconst query = new URLSearchParams(data as unknown as Record<string, string>).toString();\n\t\treturn query ? `${path}?${query}` : path;\n\t}\n\n\t/**\n\t * Is either command or control key down at the moment\n\t */\n\tisSpecialKeyPressed(): boolean {\n\t\treturn Object.values(this.specialKeys).some((value) => value);\n\t}\n\n\t/**\n\t * Reset all entries in `specialKeys` to false\n\t */\n\tresetSpecialKeys() {\n\t\tfor (const key of Object.keys(this.specialKeys)) {\n\t\t\tthis.specialKeys[key] = false;\n\t\t}\n\t}\n\n\t/**\n\t * Adjust `specialKeys` on keyDown\n\t */\n\tonKeyDown = (event: KeyboardEvent): void => {\n\t\tif (this.specialKeys.hasOwnProperty(event.key)) {\n\t\t\tthis.specialKeys[event.key] = true;\n\t\t}\n\t};\n\n\t/**\n\t * Adjust `specialKeys` on keyUp\n\t */\n\tonKeyUp = (event: KeyboardEvent): void => {\n\t\tif (this.specialKeys.hasOwnProperty(event.key)) {\n\t\t\tthis.specialKeys[event.key] = false;\n\t\t}\n\t};\n}\n"],"names":["Plugin","constructor","options","super","this","name","requires","swup","defaults","formSelector","specialKeys","Meta","Control","Shift","formSubmitDelegate","onKeyDown","event","hasOwnProperty","key","onKeyUp","mount","hooks","create","delegateEvent","beforeFormSubmit","bind","capture","document","addEventListener","unmount","destroy","removeEventListener","form","delegateTarget","action","getAttribute","getCurrentUrl","opensInNewTabFromKeyPress","isSpecialKeyPressed","opensInNewTabFromTargetAttr","shouldIgnoreVisit","el","callSync","dataset","swupOriginalFormTarget","setAttribute","requestAnimationFrame","restorePreviousFormTarget","once","submitForm","removeAttribute","url","hash","method","data","body","getFormInfo","params","appendQueryParams","console","warn","preventDefault","cache","delete","navigate","Location","fromUrl","toUpperCase","encoding","toLowerCase","multipart","FormData","URLSearchParams","path","split","query","toString","Object","values","some","value","resetSpecialKeys","keys"],"mappings":"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"}