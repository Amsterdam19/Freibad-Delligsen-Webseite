{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["import Plugin from '@swup/plugin';\nimport { getCurrentUrl, Handler, Location } from 'swup';\nimport type { DelegateEvent, DelegateEventHandler, DelegateEventUnsubscribe, PageData } from 'swup';\n\ndeclare module 'swup' {\n\texport interface Swup {\n\t\tpreload?: (url: string) => Promise<PageData>;\n\t\tpreloadLinks?: () => void;\n\t}\n\texport interface HookDefinitions {\n\t\t'link:hover': { el: HTMLAnchorElement; event: DelegateEvent };\n\t\t'page:preload': { page: PageData };\n\t}\n}\n\nexport type PluginOptions = {\n\tthrottle: number;\n\tpreloadInitialPage: boolean;\n};\n\nexport default class SwupPreloadPlugin extends Plugin {\n\tname = 'SwupPreloadPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: PluginOptions = {\n\t\tthrottle: 5,\n\t\tpreloadInitialPage: true\n\t};\n\n\toptions: PluginOptions;\n\n\tpreloadPromises = new Map();\n\n\tmouseEnterDelegate?: DelegateEventUnsubscribe;\n\ttouchStartDelegate?: DelegateEventUnsubscribe;\n\n\tconstructor(options: Partial<PluginOptions> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\tconst swup = this.swup;\n\n\t\tif (!swup.options.cache) {\n\t\t\tconsole.warn('SwupPreloadPlugin: swup cache needs to be enabled for preloading');\n\t\t\treturn;\n\t\t}\n\n\t\tswup.hooks.create('page:preload');\n\t\tswup.hooks.create('link:hover');\n\n\t\tswup.preload = this.preload;\n\t\tswup.preloadLinks = this.preloadLinks;\n\n\t\t// register mouseenter handler\n\t\tthis.mouseEnterDelegate = swup.delegateEvent(\n\t\t\tswup.options.linkSelector,\n\t\t\t'mouseenter',\n\t\t\tthis.onMouseEnter.bind(this),\n\t\t\t{ capture: true }\n\t\t);\n\n\t\t// register touchstart handler\n\t\tthis.touchStartDelegate = swup.delegateEvent(\n\t\t\tswup.options.linkSelector,\n\t\t\t'touchstart',\n\t\t\tthis.onTouchStart.bind(this),\n\t\t\t{ capture: true }\n\t\t);\n\n\t\t// preload links with [data-swup-preload] attr after page views\n\t\tthis.on('page:view', this.onPageView);\n\n\t\t// inject custom promise whenever a page is loaded\n\t\tthis.replace('page:load', this.onPageLoad);\n\n\t\t// initial preload of links with [data-swup-preload] attr\n\t\tthis.preloadLinks();\n\n\t\t// cache unmodified dom of initial/current page\n\t\tif (this.options.preloadInitialPage) {\n\t\t\tthis.preload(getCurrentUrl());\n\t\t}\n\t}\n\n\tunmount() {\n\t\tthis.swup.preload = undefined;\n\t\tthis.swup.preloadLinks = undefined;\n\n\t\tthis.preloadPromises.clear();\n\n\t\tthis.mouseEnterDelegate?.destroy();\n\t\tthis.touchStartDelegate?.destroy();\n\t}\n\n\tonPageView() {\n\t\tthis.preloadLinks();\n\t}\n\n\tonPageLoad: Handler<'page:load'> = (visit, args, defaultHandler) => {\n\t\tconst { url } = visit.to;\n\t\tif (this.preloadPromises.has(url)) {\n\t\t\treturn this.preloadPromises.get(url);\n\t\t}\n\t\treturn defaultHandler?.(visit, args);\n\t};\n\n\tdeviceSupportsHover() {\n\t\treturn window.matchMedia('(hover: hover)').matches;\n\t}\n\n\tonMouseEnter: DelegateEventHandler = async (event) => {\n\t\t// Make sure mouseenter is only fired once even on links with nested html\n\t\tif (event.target !== event.delegateTarget) return;\n\t\t// Return early on devices that don't support hover\n\t\tif (!this.deviceSupportsHover()) return;\n\n\t\tconst el = event.delegateTarget;\n\t\tif (!(el instanceof HTMLAnchorElement)) return;\n\n\t\tthis.swup.hooks.callSync('link:hover', { el, event });\n\t\tthis.preloadLink(el);\n\t};\n\n\tonTouchStart: DelegateEventHandler = (event) => {\n\t\t// Return early on devices that support hover\n\t\tif (this.deviceSupportsHover()) return;\n\n\t\tconst el = event.delegateTarget;\n\t\tif (!(el instanceof HTMLAnchorElement)) return;\n\n\t\tthis.preloadLink(el);\n\t};\n\n\tpreloadLink(el: HTMLAnchorElement) {\n\t\tconst { url, href } = Location.fromElement(el);\n\n\t\t// Bail early if the visit should be ignored by swup\n\t\tif (this.swup.shouldIgnoreVisit(href, { el })) return;\n\n\t\t// Bail early if the link points to the current page\n\t\tif (url === getCurrentUrl()) return;\n\n\t\t// Bail early if the page is already in the cache\n\t\tif (this.swup.cache.has(url)) return;\n\n\t\t// Bail early if there is already a preload running\n\t\tif (this.preloadPromises.has(url)) return;\n\n\t\t// Bail early if there are more then the maximum concurrent preloads running\n\t\tif (this.preloadPromises.size >= this.options.throttle) return;\n\n\t\tconst preloadPromise = this.preload(url);\n\t\tpreloadPromise\n\t\t\t.catch(() => {})\n\t\t\t.finally(() => {\n\t\t\t\tthis.preloadPromises.delete(url);\n\t\t\t});\n\t\tthis.preloadPromises.set(url, preloadPromise);\n\t}\n\n\tpreload = async (url: string) => {\n\t\tconst page = await this.swup.fetchPage(url);\n\t\tawait this.swup.hooks.call('page:preload', { page });\n\t\treturn page;\n\t};\n\n\tpreloadLinks = (): void => {\n\t\tdocument\n\t\t\t.querySelectorAll<HTMLAnchorElement>('a[data-swup-preload], [data-swup-preload-all] a')\n\t\t\t.forEach((el) => {\n\t\t\t\tif (this.swup.shouldIgnoreVisit(el.href, { el })) return;\n\t\t\t\tthis.swup.preload?.(el.href);\n\t\t\t});\n\t};\n}\n"],"names":["SwupPreloadPlugin","Plugin","constructor","options","_this","super","this","name","requires","swup","defaults","throttle","preloadInitialPage","preloadPromises","Map","mouseEnterDelegate","touchStartDelegate","onPageLoad","visit","args","defaultHandler","url","to","has","get","onMouseEnter","async","event","target","delegateTarget","deviceSupportsHover","el","HTMLAnchorElement","hooks","callSync","preloadLink","onTouchStart","preload","page","fetchPage","call","preloadLinks","document","querySelectorAll","forEach","_this$swup$preload","_this$swup","shouldIgnoreVisit","href","_extends","mount","cache","create","delegateEvent","linkSelector","bind","capture","on","onPageView","replace","getCurrentUrl","console","warn","unmount","_this$mouseEnterDeleg","_this$touchStartDeleg","undefined","clear","destroy","window","matchMedia","matches","Location","fromElement","size","preloadPromise","catch","finally","delete","set"],"mappings":"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"}