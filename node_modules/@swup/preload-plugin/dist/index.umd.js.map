{"version":3,"file":"index.umd.js","sources":["../node_modules/@swup/plugin/dist/index.modern.js","../src/index.ts"],"sourcesContent":["function r(){return r=Object.assign?Object.assign.bind():function(r){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t])}return r},r.apply(this,arguments)}const n=r=>String(r).split(\".\").map(r=>String(parseInt(r||\"0\",10))).concat([\"0\",\"0\"]).slice(0,3).join(\".\");class e{constructor(){this.isSwupPlugin=!0,this.swup=void 0,this.version=void 0,this.requires={},this.handlersToUnregister=[]}mount(){}unmount(){this.handlersToUnregister.forEach(r=>r()),this.handlersToUnregister=[]}_beforeMount(){if(!this.name)throw new Error(\"You must define a name of plugin when creating a class.\")}_afterUnmount(){}_checkRequirements(){return\"object\"!=typeof this.requires||Object.entries(this.requires).forEach(([r,e])=>{if(!function(r,e,t){const s=function(r,n){var e;if(\"swup\"===r)return null!=(e=n.version)?e:\"\";{var t;const e=n.findPlugin(r);return null!=(t=null==e?void 0:e.version)?t:\"\"}}(r,t);return!!s&&((r,e)=>e.every(e=>{const[,t,s]=e.match(/^([\\D]+)?(.*)$/)||[];var o,i;return((r,n)=>{const e={\"\":r=>0===r,\">\":r=>r>0,\">=\":r=>r>=0,\"<\":r=>r<0,\"<=\":r=>r<=0};return(e[n]||e[\"\"])(r)})((i=s,o=n(o=r),i=n(i),o.localeCompare(i,void 0,{numeric:!0})),t||\">=\")}))(s,e)}(r,e=Array.isArray(e)?e:[e],this.swup)){const n=`${r} ${e.join(\", \")}`;throw new Error(`Plugin version mismatch: ${this.name} requires ${n}`)}}),!0}on(r,n,e={}){var t;n=!(t=n).name.startsWith(\"bound \")||t.hasOwnProperty(\"prototype\")?n.bind(this):n;const s=this.swup.hooks.on(r,n,e);return this.handlersToUnregister.push(s),s}once(n,e,t={}){return this.on(n,e,r({},t,{once:!0}))}before(n,e,t={}){return this.on(n,e,r({},t,{before:!0}))}replace(n,e,t={}){return this.on(n,e,r({},t,{replace:!0}))}off(r,n){return this.swup.hooks.off(r,n)}}export{e as default};\n//# sourceMappingURL=index.modern.js.map\n","import Plugin from '@swup/plugin';\nimport { getCurrentUrl, Handler, Location } from 'swup';\nimport type { DelegateEvent, DelegateEventHandler, DelegateEventUnsubscribe, PageData } from 'swup';\n\ndeclare module 'swup' {\n\texport interface Swup {\n\t\tpreload?: (url: string) => Promise<PageData>;\n\t\tpreloadLinks?: () => void;\n\t}\n\texport interface HookDefinitions {\n\t\t'link:hover': { el: HTMLAnchorElement; event: DelegateEvent };\n\t\t'page:preload': { page: PageData };\n\t}\n}\n\nexport type PluginOptions = {\n\tthrottle: number;\n\tpreloadInitialPage: boolean;\n};\n\nexport default class SwupPreloadPlugin extends Plugin {\n\tname = 'SwupPreloadPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: PluginOptions = {\n\t\tthrottle: 5,\n\t\tpreloadInitialPage: true\n\t};\n\n\toptions: PluginOptions;\n\n\tpreloadPromises = new Map();\n\n\tmouseEnterDelegate?: DelegateEventUnsubscribe;\n\ttouchStartDelegate?: DelegateEventUnsubscribe;\n\n\tconstructor(options: Partial<PluginOptions> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\tconst swup = this.swup;\n\n\t\tif (!swup.options.cache) {\n\t\t\tconsole.warn('SwupPreloadPlugin: swup cache needs to be enabled for preloading');\n\t\t\treturn;\n\t\t}\n\n\t\tswup.hooks.create('page:preload');\n\t\tswup.hooks.create('link:hover');\n\n\t\tswup.preload = this.preload;\n\t\tswup.preloadLinks = this.preloadLinks;\n\n\t\t// register mouseenter handler\n\t\tthis.mouseEnterDelegate = swup.delegateEvent(\n\t\t\tswup.options.linkSelector,\n\t\t\t'mouseenter',\n\t\t\tthis.onMouseEnter.bind(this),\n\t\t\t{ capture: true }\n\t\t);\n\n\t\t// register touchstart handler\n\t\tthis.touchStartDelegate = swup.delegateEvent(\n\t\t\tswup.options.linkSelector,\n\t\t\t'touchstart',\n\t\t\tthis.onTouchStart.bind(this),\n\t\t\t{ capture: true }\n\t\t);\n\n\t\t// preload links with [data-swup-preload] attr after page views\n\t\tthis.on('page:view', this.onPageView);\n\n\t\t// inject custom promise whenever a page is loaded\n\t\tthis.replace('page:load', this.onPageLoad);\n\n\t\t// initial preload of links with [data-swup-preload] attr\n\t\tthis.preloadLinks();\n\n\t\t// cache unmodified dom of initial/current page\n\t\tif (this.options.preloadInitialPage) {\n\t\t\tthis.preload(getCurrentUrl());\n\t\t}\n\t}\n\n\tunmount() {\n\t\tthis.swup.preload = undefined;\n\t\tthis.swup.preloadLinks = undefined;\n\n\t\tthis.preloadPromises.clear();\n\n\t\tthis.mouseEnterDelegate?.destroy();\n\t\tthis.touchStartDelegate?.destroy();\n\t}\n\n\tonPageView() {\n\t\tthis.preloadLinks();\n\t}\n\n\tonPageLoad: Handler<'page:load'> = (visit, args, defaultHandler) => {\n\t\tconst { url } = visit.to;\n\t\tif (this.preloadPromises.has(url)) {\n\t\t\treturn this.preloadPromises.get(url);\n\t\t}\n\t\treturn defaultHandler?.(visit, args);\n\t};\n\n\tdeviceSupportsHover() {\n\t\treturn window.matchMedia('(hover: hover)').matches;\n\t}\n\n\tonMouseEnter: DelegateEventHandler = async (event) => {\n\t\t// Make sure mouseenter is only fired once even on links with nested html\n\t\tif (event.target !== event.delegateTarget) return;\n\t\t// Return early on devices that don't support hover\n\t\tif (!this.deviceSupportsHover()) return;\n\n\t\tconst el = event.delegateTarget;\n\t\tif (!(el instanceof HTMLAnchorElement)) return;\n\n\t\tthis.swup.hooks.callSync('link:hover', { el, event });\n\t\tthis.preloadLink(el);\n\t};\n\n\tonTouchStart: DelegateEventHandler = (event) => {\n\t\t// Return early on devices that support hover\n\t\tif (this.deviceSupportsHover()) return;\n\n\t\tconst el = event.delegateTarget;\n\t\tif (!(el instanceof HTMLAnchorElement)) return;\n\n\t\tthis.preloadLink(el);\n\t};\n\n\tpreloadLink(el: HTMLAnchorElement) {\n\t\tconst { url, href } = Location.fromElement(el);\n\n\t\t// Bail early if the visit should be ignored by swup\n\t\tif (this.swup.shouldIgnoreVisit(href, { el })) return;\n\n\t\t// Bail early if the link points to the current page\n\t\tif (url === getCurrentUrl()) return;\n\n\t\t// Bail early if the page is already in the cache\n\t\tif (this.swup.cache.has(url)) return;\n\n\t\t// Bail early if there is already a preload running\n\t\tif (this.preloadPromises.has(url)) return;\n\n\t\t// Bail early if there are more then the maximum concurrent preloads running\n\t\tif (this.preloadPromises.size >= this.options.throttle) return;\n\n\t\tconst preloadPromise = this.preload(url);\n\t\tpreloadPromise\n\t\t\t.catch(() => {})\n\t\t\t.finally(() => {\n\t\t\t\tthis.preloadPromises.delete(url);\n\t\t\t});\n\t\tthis.preloadPromises.set(url, preloadPromise);\n\t}\n\n\tpreload = async (url: string) => {\n\t\tconst page = await this.swup.fetchPage(url);\n\t\tawait this.swup.hooks.call('page:preload', { page });\n\t\treturn page;\n\t};\n\n\tpreloadLinks = (): void => {\n\t\tdocument\n\t\t\t.querySelectorAll<HTMLAnchorElement>('a[data-swup-preload], [data-swup-preload-all] a')\n\t\t\t.forEach((el) => {\n\t\t\t\tif (this.swup.shouldIgnoreVisit(el.href, { el })) return;\n\t\t\t\tthis.swup.preload?.(el.href);\n\t\t\t});\n\t};\n}\n"],"names":["n","r","String","split","map","parseInt","concat","slice","join","e","every","t","s","match","o","i","localeCompare","numeric","Plugin","constructor","options","super","_this2","this","_this","name","requires","swup","defaults","throttle","preloadInitialPage","preloadPromises","Map","mouseEnterDelegate","touchStartDelegate","onPageLoad","visit","args","defaultHandler","url","to","has","get","onMouseEnter","event","target","delegateTarget","Promise","resolve","deviceSupportsHover","el","HTMLAnchorElement","hooks","callSync","preloadLink","reject","onTouchStart","preload","fetchPage","then","page","call","preloadLinks","document","querySelectorAll","forEach","shouldIgnoreVisit","href","mount","cache","create","delegateEvent","linkSelector","bind","capture","on","onPageView","replace","getCurrentUrl","console","warn","unmount","undefined","clear","destroy","window","matchMedia","matches","Location","fromElement","size","preloadPromise","catch","finally","delete","set"],"mappings":"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"}