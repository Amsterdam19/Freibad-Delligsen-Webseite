{"version":3,"file":"index.module.js","sources":["../src/index.ts"],"sourcesContent":["import type { Handler, Visit } from 'swup';\nimport { forceReflow } from 'swup';\nimport Plugin from '@swup/plugin';\n\ndeclare module 'swup' {\n\texport interface VisitAnimation {\n\t\t/** Parallel visit: run in and out animation at the same time */\n\t\tparallel?: boolean;\n\t}\n}\n\ntype PluginOptions = {\n\tcontainers: string[];\n};\n\ntype ContainerSet = {\n\tselector: string;\n\tprevious: HTMLElement;\n\tnext: HTMLElement;\n};\n\nexport default class SwupParallelPlugin extends Plugin {\n\tname = 'SwupParallelPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: PluginOptions = { containers: [] };\n\toptions: PluginOptions;\n\n\toriginalContainers: string[] | null = null;\n\tpreviousContainers: Element[] = [];\n\tnextContainers: Element[] = [];\n\n\tconstructor(options: Partial<PluginOptions> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\t// No containers passed? Use all content containers\n\t\tif (!this.options.containers.length) {\n\t\t\tthis.options.containers = this.swup.options.containers;\n\t\t}\n\n\t\t// On visit: check for containers and mark as parallel visit\n\t\t// Run after user hooks to allow disabling parallel animations beforehand\n\t\tthis.on('visit:start', this.startVisit, { priority: 1 });\n\t\t// Before awaiting out animation: skip\n\t\tthis.before('animation:out:await', this.skipOutAnimation, { priority: 1 });\n\t\t// Before content replace: insert new containers\n\t\tthis.before('content:replace', this.insertContainers, { priority: 1 });\n\t\t// After content replace: reset containers\n\t\tthis.on('content:replace', this.resetContainers);\n\t\t// After visit: remove old containers\n\t\tthis.on('visit:end', this.cleanupContainers);\n\t}\n\n\tstartVisit: Handler<'visit:start'> = (visit) => {\n\t\tthis.originalContainers = null;\n\n\t\t// Only mark as parallel visit if containers found and animation matches\n\t\tif (this.visitHasPotentialParallelAnimation(visit)) {\n\t\t\tvisit.animation.wait = true;\n\t\t\tvisit.animation.parallel = true;\n\t\t}\n\t};\n\n\tskipOutAnimation: Handler<'animation:out:await'> = (visit, args) => {\n\t\tif (this.isParallelVisit(visit)) {\n\t\t\targs.skip = true;\n\t\t}\n\t};\n\n\tinsertContainers: Handler<'content:replace'> = (visit, { page }) => {\n\t\tif (!this.isParallelVisit(visit)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Replace parallel containers ourselves\n\t\tconst containerSets = this.getContainersForVisit(visit, page);\n\t\tconst parallelContainers = containerSets.map(({ selector }) => selector);\n\t\tcontainerSets.forEach(({ previous, next }) => {\n\t\t\tthis.previousContainers.push(previous);\n\t\t\tthis.nextContainers.push(next);\n\n\t\t\tprevious.setAttribute('aria-hidden', 'true');\n\t\t\tprevious.before(next);\n\n\t\t\tnext.classList.add('is-next-container');\n\t\t\tforceReflow(next);\n\t\t\tprevious.classList.add('is-previous-container');\n\t\t\tnext.classList.remove('is-next-container');\n\t\t});\n\n\t\t// Hand all other non-parallel containers to swup\n\t\tthis.originalContainers = visit.containers;\n\t\tvisit.containers = visit.containers.filter((s) => !parallelContainers.includes(s));\n\t};\n\n\tresetContainers: Handler<'content:replace'> = (visit) => {\n\t\tif (this.originalContainers) {\n\t\t\tvisit.containers = this.originalContainers;\n\t\t}\n\t};\n\n\tcleanupContainers = () => {\n\t\tthis.previousContainers.forEach((c) => c.remove());\n\t\tthis.nextContainers.forEach((c) => c.classList.remove('is-next-container'));\n\t\tthis.previousContainers = [];\n\t\tthis.nextContainers = [];\n\t};\n\n\tgetContainersForVisit(visit: Visit, { html }: { html: string }): ContainerSet[] {\n\t\tconst { containers: parallelContainers } = this.options;\n\t\tconst containersInVisit = parallelContainers.filter((s) => visit.containers.includes(s));\n\t\tif (!containersInVisit.length) {\n\t\t\tconsole.warn('No parallel containers found in list of replaced containers');\n\t\t\treturn [];\n\t\t}\n\n\t\tconst incomingDocument = new DOMParser().parseFromString(html, 'text/html');\n\n\t\treturn containersInVisit.reduce((containers, selector: string) => {\n\t\t\tconst previous = document.querySelector<HTMLElement>(selector);\n\t\t\tconst next = incomingDocument.querySelector<HTMLElement>(selector);\n\t\t\treturn previous && next ? [...containers, { selector, previous, next }] : containers;\n\t\t}, [] as ContainerSet[]);\n\t}\n\n\tisParallelVisit(visit: Visit) {\n\t\treturn visit.animation.animate && visit.animation.parallel;\n\t}\n\n\tmarkVisitAsParallelAnimation(visit: Visit) {\n\t\tvisit.animation.wait = true;\n\t\tvisit.animation.parallel = true;\n\t}\n\n\tvisitHasPotentialParallelAnimation(visit: Visit) {\n\t\t// Checking for visit.animation.parallel !== false here allows explicitly\n\t\t// disabling parallel animations in user hooks before this plugin executes\n\t\treturn (\n\t\t\tvisit.animation.animate &&\n\t\t\tvisit.animation.parallel !== false &&\n\t\t\tthis.visitHasParallelContainers(visit)\n\t\t);\n\t}\n\n\tvisitHasParallelContainers(visit: Visit) {\n\t\treturn this.options.containers.some((selector) => {\n\t\t\tconst container = document.querySelector(selector);\n\t\t\treturn container?.matches(visit.containers.join(','));\n\t\t});\n\t}\n}\n"],"names":["SwupParallelPlugin","Plugin","constructor","options","super","this","name","requires","swup","defaults","containers","originalContainers","previousContainers","nextContainers","startVisit","visit","visitHasPotentialParallelAnimation","animation","wait","parallel","skipOutAnimation","args","isParallelVisit","skip","insertContainers","_ref","page","containerSets","getContainersForVisit","parallelContainers","map","_ref2","selector","forEach","_ref3","previous","next","push","setAttribute","before","classList","add","forceReflow","remove","filter","s","includes","resetContainers","cleanupContainers","c","mount","length","on","priority","_ref4","html","containersInVisit","console","warn","incomingDocument","DOMParser","parseFromString","reduce","document","querySelector","animate","markVisitAsParallelAnimation","visitHasParallelContainers","some","container","matches","join"],"mappings":"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"}