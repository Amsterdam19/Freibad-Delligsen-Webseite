{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["import type { Handler, Visit } from 'swup';\nimport { forceReflow } from 'swup';\nimport Plugin from '@swup/plugin';\n\ndeclare module 'swup' {\n\texport interface VisitAnimation {\n\t\t/** Parallel visit: run in and out animation at the same time */\n\t\tparallel?: boolean;\n\t}\n}\n\ntype PluginOptions = {\n\tcontainers: string[];\n};\n\ntype ContainerSet = {\n\tselector: string;\n\tprevious: HTMLElement;\n\tnext: HTMLElement;\n};\n\nexport default class SwupParallelPlugin extends Plugin {\n\tname = 'SwupParallelPlugin';\n\n\trequires = { swup: '>=4' };\n\n\tdefaults: PluginOptions = { containers: [] };\n\toptions: PluginOptions;\n\n\toriginalContainers: string[] | null = null;\n\tpreviousContainers: Element[] = [];\n\tnextContainers: Element[] = [];\n\n\tconstructor(options: Partial<PluginOptions> = {}) {\n\t\tsuper();\n\t\tthis.options = { ...this.defaults, ...options };\n\t}\n\n\tmount() {\n\t\t// No containers passed? Use all content containers\n\t\tif (!this.options.containers.length) {\n\t\t\tthis.options.containers = this.swup.options.containers;\n\t\t}\n\n\t\t// On visit: check for containers and mark as parallel visit\n\t\t// Run after user hooks to allow disabling parallel animations beforehand\n\t\tthis.on('visit:start', this.startVisit, { priority: 1 });\n\t\t// Before awaiting out animation: skip\n\t\tthis.before('animation:out:await', this.skipOutAnimation, { priority: 1 });\n\t\t// Before content replace: insert new containers\n\t\tthis.before('content:replace', this.insertContainers, { priority: 1 });\n\t\t// After content replace: reset containers\n\t\tthis.on('content:replace', this.resetContainers);\n\t\t// After visit: remove old containers\n\t\tthis.on('visit:end', this.cleanupContainers);\n\t}\n\n\tstartVisit: Handler<'visit:start'> = (visit) => {\n\t\tthis.originalContainers = null;\n\n\t\t// Only mark as parallel visit if containers found and animation matches\n\t\tif (this.visitHasPotentialParallelAnimation(visit)) {\n\t\t\tvisit.animation.wait = true;\n\t\t\tvisit.animation.parallel = true;\n\t\t}\n\t};\n\n\tskipOutAnimation: Handler<'animation:out:await'> = (visit, args) => {\n\t\tif (this.isParallelVisit(visit)) {\n\t\t\targs.skip = true;\n\t\t}\n\t};\n\n\tinsertContainers: Handler<'content:replace'> = (visit, { page }) => {\n\t\tif (!this.isParallelVisit(visit)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Replace parallel containers ourselves\n\t\tconst containerSets = this.getContainersForVisit(visit, page);\n\t\tconst parallelContainers = containerSets.map(({ selector }) => selector);\n\t\tcontainerSets.forEach(({ previous, next }) => {\n\t\t\tthis.previousContainers.push(previous);\n\t\t\tthis.nextContainers.push(next);\n\n\t\t\tprevious.setAttribute('aria-hidden', 'true');\n\t\t\tprevious.before(next);\n\n\t\t\tnext.classList.add('is-next-container');\n\t\t\tforceReflow(next);\n\t\t\tprevious.classList.add('is-previous-container');\n\t\t\tnext.classList.remove('is-next-container');\n\t\t});\n\n\t\t// Hand all other non-parallel containers to swup\n\t\tthis.originalContainers = visit.containers;\n\t\tvisit.containers = visit.containers.filter((s) => !parallelContainers.includes(s));\n\t};\n\n\tresetContainers: Handler<'content:replace'> = (visit) => {\n\t\tif (this.originalContainers) {\n\t\t\tvisit.containers = this.originalContainers;\n\t\t}\n\t};\n\n\tcleanupContainers = () => {\n\t\tthis.previousContainers.forEach((c) => c.remove());\n\t\tthis.nextContainers.forEach((c) => c.classList.remove('is-next-container'));\n\t\tthis.previousContainers = [];\n\t\tthis.nextContainers = [];\n\t};\n\n\tgetContainersForVisit(visit: Visit, { html }: { html: string }): ContainerSet[] {\n\t\tconst { containers: parallelContainers } = this.options;\n\t\tconst containersInVisit = parallelContainers.filter((s) => visit.containers.includes(s));\n\t\tif (!containersInVisit.length) {\n\t\t\tconsole.warn('No parallel containers found in list of replaced containers');\n\t\t\treturn [];\n\t\t}\n\n\t\tconst incomingDocument = new DOMParser().parseFromString(html, 'text/html');\n\n\t\treturn containersInVisit.reduce((containers, selector: string) => {\n\t\t\tconst previous = document.querySelector<HTMLElement>(selector);\n\t\t\tconst next = incomingDocument.querySelector<HTMLElement>(selector);\n\t\t\treturn previous && next ? [...containers, { selector, previous, next }] : containers;\n\t\t}, [] as ContainerSet[]);\n\t}\n\n\tisParallelVisit(visit: Visit) {\n\t\treturn visit.animation.animate && visit.animation.parallel;\n\t}\n\n\tmarkVisitAsParallelAnimation(visit: Visit) {\n\t\tvisit.animation.wait = true;\n\t\tvisit.animation.parallel = true;\n\t}\n\n\tvisitHasPotentialParallelAnimation(visit: Visit) {\n\t\t// Checking for visit.animation.parallel !== false here allows explicitly\n\t\t// disabling parallel animations in user hooks before this plugin executes\n\t\treturn (\n\t\t\tvisit.animation.animate &&\n\t\t\tvisit.animation.parallel !== false &&\n\t\t\tthis.visitHasParallelContainers(visit)\n\t\t);\n\t}\n\n\tvisitHasParallelContainers(visit: Visit) {\n\t\treturn this.options.containers.some((selector) => {\n\t\t\tconst container = document.querySelector(selector);\n\t\t\treturn container?.matches(visit.containers.join(','));\n\t\t});\n\t}\n}\n"],"names":["SwupParallelPlugin","Plugin","constructor","options","super","this","name","requires","swup","defaults","containers","originalContainers","previousContainers","nextContainers","startVisit","visit","visitHasPotentialParallelAnimation","animation","wait","parallel","skipOutAnimation","args","isParallelVisit","skip","insertContainers","page","containerSets","getContainersForVisit","parallelContainers","map","selector","forEach","previous","next","push","setAttribute","before","classList","add","forceReflow","remove","filter","s","includes","resetContainers","cleanupContainers","c","_extends","mount","length","on","priority","html","containersInVisit","console","warn","incomingDocument","DOMParser","parseFromString","reduce","document","querySelector","animate","markVisitAsParallelAnimation","visitHasParallelContainers","some","container","matches","join"],"mappings":"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"}